name: build-sqlite

on:
  workflow_dispatch:
    inputs:
      version:
        description: "SQLite autoconf/tool version (e.g. 3460100)"
        required: true
        default: "3460100"
      arch:
        description: "Arch list (space or comma separated: amd64 arm64 armv7 ppc64le s390x riscv64)"
        required: false
        default: "amd64 arm64 armv7 ppc64le s390x riscv64 loong64"
      repo:
        description: "Release repo to upload (owner/repo)"
        required: false
        default: "HandSonic/1Panel-offline-installer-V2"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build sqlite3 for arches
        env:
          VERSION: ${{ inputs.version }}
          ARCH_INPUT: ${{ inputs.arch }}
        run: |
          set -e
          ARCH_LIST=$(echo "${ARCH_INPUT:-"amd64 arm64 armv7 ppc64le s390x riscv64 loong64"}" | tr ',' ' ')
          mkdir -p dist
          cat > Dockerfile.sqlite <<'EOF'
          ARG SQLITE_VERSION
          FROM alpine:3.20
          ARG SQLITE_VERSION
          RUN apk add --no-cache build-base curl tar
          RUN curl -fsSL https://sqlite.org/2024/sqlite-autoconf-${SQLITE_VERSION}.tar.gz -o /tmp/sqlite.tar.gz \
            && tar xf /tmp/sqlite.tar.gz -C /tmp \
            && cd /tmp/sqlite-autoconf-${SQLITE_VERSION} \
            && ./configure --disable-shared --enable-static --prefix=/usr/local \
            && make -j$(nproc) \
            && make install DESTDIR=/tmp/install
          RUN mkdir -p /out && cp /tmp/install/usr/local/bin/sqlite3 /out/sqlite3
          EOF
          for ARCH in ${ARCH_LIST}; do
            PLATFORM="linux/${ARCH}"
            OUT_DIR="out/${ARCH}"
            mkdir -p "${OUT_DIR}"
            echo "==> Building sqlite3 for ${ARCH}"
            if [ "${ARCH}" = "loong64" ]; then
              echo "::warning title=sqlite3 loong64 skip::loong64 cross build not supported in this pipeline; please provide prebuilt sqlite3-linux-loong64-${VERSION}.tar.gz via release"
              rm -rf "${OUT_DIR}"
              continue
            fi
            if ! docker buildx build --platform "${PLATFORM}" --build-arg SQLITE_VERSION="${VERSION}" -f Dockerfile.sqlite --output "type=local,dest=${OUT_DIR}" .; then
              echo "::warning title=sqlite3 build failed::${ARCH} build failed, skipping"
              rm -rf "${OUT_DIR}"
              continue
            fi
            if [ -f "${OUT_DIR}/sqlite3" ]; then
              tar -czf "dist/sqlite3-linux-${ARCH}-${VERSION}.tar.gz" -C "${OUT_DIR}" sqlite3
            else
              echo "::warning title=sqlite3 missing::${ARCH} sqlite3 not found after build"
            fi
          done
          ls -lh dist || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sqlite3-${{ inputs.version }}
          path: dist/*.tar.gz

      - name: Publish Release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          REPO: ${{ inputs.repo }}
        run: |
          set -e
          if [ -z "${REPO}" ]; then
            echo "repo input is required"
            exit 1
          fi
          if ! gh release view "sqlite-${VERSION}" -R "${REPO}" >/dev/null 2>&1; then
            gh release create "sqlite-${VERSION}" -R "${REPO}" -t "sqlite-${VERSION}" -n "sqlite3 binaries for ${VERSION}" dist/*.tar.gz
          else
            gh release upload "sqlite-${VERSION}" dist/*.tar.gz -R "${REPO}" --clobber
          fi
