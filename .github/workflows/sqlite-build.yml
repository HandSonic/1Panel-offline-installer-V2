name: build-sqlite

on:
  workflow_dispatch:
    inputs:
      version:
        description: "SQLite autoconf/tool version (e.g. 3460100)"
        required: true
        default: "3460100"
      arch:
        description: "Arch list (space or comma separated: amd64 arm64 armv7 ppc64le s390x riscv64)"
        required: false
        default: "amd64 arm64 armv7 ppc64le s390x riscv64 loong64"
      repo:
        description: "Release repo to upload (owner/repo)"
        required: false
        default: "HandSonic/1Panel-offline-installer-V2"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64, armv7, ppc64le, s390x, riscv64, loong64]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Skip if arch not requested
        env:
          ARCH_INPUT: ${{ inputs.arch }}
        run: |
          ARCH_LIST=$(echo "${ARCH_INPUT:-"amd64 arm64 armv7 ppc64le s390x riscv64 loong64"}" | tr ',' ' ')
          if ! echo " ${ARCH_LIST} " | grep -q " ${{ matrix.arch }} "; then
            echo "Arch ${{ matrix.arch }} not requested, skipping."
            exit 0
          fi

      - name: Build sqlite3
        id: buildsqlite
        env:
          VERSION: ${{ inputs.version }}
          REPO: ${{ inputs.repo }}
        run: |
          set -e
          ARCH="${{ matrix.arch }}"
          if [ "${ARCH}" = "loong64" ]; then
            URL="https://github.com/${REPO}/releases/download/sqlite-${VERSION}/sqlite3-linux-loong64-${VERSION}.tar.gz"
            echo "Attempting to fetch prebuilt loong64 sqlite3 from ${URL}"
            if curl -fL "${URL}" -o "sqlite3-linux-loong64-${VERSION}.tar.gz"; then
              exit 0
            else
              echo "::warning title=sqlite3 loong64 missing::prebuilt sqlite3-linux-loong64-${VERSION}.tar.gz not found in ${REPO}, skipping loong64"
              exit 0
            fi
          fi
          cat > Dockerfile.sqlite <<'EOF'
          ARG SQLITE_VERSION
          FROM alpine:3.20
          ARG SQLITE_VERSION
          RUN apk add --no-cache build-base curl tar
          RUN curl -fsSL https://sqlite.org/2024/sqlite-autoconf-${SQLITE_VERSION}.tar.gz -o /tmp/sqlite.tar.gz \
            && tar xf /tmp/sqlite.tar.gz -C /tmp \
            && cd /tmp/sqlite-autoconf-${SQLITE_VERSION} \
            && ./configure --disable-shared --enable-static --prefix=/usr/local \
            && make -j$(nproc) \
            && make install DESTDIR=/tmp/install
          RUN mkdir -p /out && cp /tmp/install/usr/local/bin/sqlite3 /out/sqlite3
          EOF
          OUT_DIR="out/${ARCH}"
          mkdir -p "${OUT_DIR}"
          PLATFORM="linux/${ARCH}"
          docker buildx build --platform "${PLATFORM}" --build-arg SQLITE_VERSION="${VERSION}" -f Dockerfile.sqlite --output "type=local,dest=${OUT_DIR}" .
          FOUND=$(find "${OUT_DIR}" -type f -name sqlite3 | head -n1 || true)
          if [ -z "${FOUND}" ]; then
            echo "::warning title=sqlite3 missing::${ARCH} sqlite3 not found after build"
            exit 0
          fi
          TAR_DIR=$(dirname "${FOUND}")
          tar -czf "sqlite3-linux-${ARCH}-${VERSION}.tar.gz" -C "${TAR_DIR}" sqlite3

      - name: Upload artifact
        if: hashFiles(format('sqlite3-linux-{0}-{1}.tar.gz', matrix.arch, inputs.version)) != ''
        uses: actions/upload-artifact@v4
        with:
          name: sqlite3-${{ inputs.version }}-${{ matrix.arch }}
          path: sqlite3-linux-${{ matrix.arch }}-${{ inputs.version }}.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: sqlite3-${{ inputs.version }}-*
          merge-multiple: true
          path: dist

      - name: Publish Release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          REPO: ${{ inputs.repo }}
        run: |
          set -e
          ls dist || true
          if [ -z "${REPO}" ]; then
            echo "repo input is required"
            exit 1
          fi
          if ! gh release view "sqlite-${VERSION}" -R "${REPO}" >/dev/null 2>&1; then
            gh release create "sqlite-${VERSION}" -R "${REPO}" -t "sqlite-${VERSION}" -n "sqlite3 binaries for ${VERSION}" dist/*.tar.gz
          else
            gh release upload "sqlite-${VERSION}" dist/*.tar.gz -R "${REPO}" --clobber
          fi
